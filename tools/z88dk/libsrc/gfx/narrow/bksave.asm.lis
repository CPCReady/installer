/tmp/tmpXXJuIoUf.asm:
     1                          MODULE bksave_asm
     2                          LINE 0, "bksave.asm"
bksave.asm:
                                
     1                          ;
     2                          ;    Fast background save
     3                          ;
     4                          ;    Generic version (just a bit slow)
     5                          ;
     6                          ;    $Id: bksave.asm,v 1.7 2016-07-02 09:01:35 dom Exp $
     7                          ;
     8                          
     9                            IF    !__CPU_INTEL__&!__CPU_GBZ80__
    10                                  SECTION smc_clib
    11                                  PUBLIC  bksave
    12                                  PUBLIC  _bksave
    13                                  PUBLIC  ___bksave
    14                                  EXTERN  pixeladdress
    15                          
    16                          
    17                          bksave:
    18                          _bksave:
    19                          ___bksave:
    20                                  push    ix
    21                                  ld      hl, 4
    22                                  add     hl, sp
    23                                  ld      e, (hl)
    24                                  inc     hl
    25                                  ld      d, (hl)                 ;sprite address
    26                                  push    de
    27                                  pop     ix
    28                          
    29                                  inc     hl
    30                                  ld      e, (hl)
    31                                  inc     hl
    32                                  inc     hl
    33                                  ld      d, (hl)                 ; x and y __gfx_coords
    34                          
    35                                  ld      h, d                    ; current x coordinate
    36                                  ld      l, e                    ; current y coordinate
    37                          
    38                                  ld      (ix+2), h
    39                                  ld      (ix+3), l
    40                          
    41                                  push    hl
    42                                  call    pixeladdress
    43                                  pop     hl
    44                          
    45                                  ld      a, (ix+0)
    46                                  ld      b, (ix+1)
    47                          
    48                                  dec     a
    49                                  srl     a
    50                                  srl     a
    51                                  srl     a
    52                                  inc     a
    53                                  inc     a                       ; INT ((Xsize-1)/8+2)
    54                                  ld      (rbytes+1), a
    55                          
    56                          bksaves:
    57                                  push    bc
    58                          
    59                          rbytes:
    60                                  ld      b, 0
    61                          rloop:
    62                                  ld      a, (de)
    63                                  ld      (ix+4), a
    64                                  inc     de
    65                                  inc     ix
    66                                  djnz    rloop
    67                          
    68                                  inc     l
    69                                  push    hl
    70                                  call    pixeladdress
    71                                  pop     hl
    72                          
    73                                  pop     bc
    74                          
    75                                  djnz    bksaves
    76                                  pop     ix
    77                                  ret
    78                            ENDIF
    79                          
