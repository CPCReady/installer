/tmp/tmpXXwpSlhW.asm:
     1                          MODULE stencil_render_asm
     2                          LINE 0, "stencil_render.asm"
stencil_render.asm:
                                
     1                          ;
     2                          ;    z88dk GFX library
     3                          ;
     4                          ;    Render the "stencil".
     5                          ;    The dithered horizontal lines base their pattern on the Y coordinate
     6                          ;    and on an 'intensity' parameter (0..11).
     7                          ;    Basic concept by Rafael de Oliveira Jannone
     8                          ;
     9                          ;    Machine code version by Stefano Bodrato, 22/4/2009
    10                          ;
    11                          ;    stencil_render(unsigned char *stencil, unsigned char intensity)
    12                          ;
    13                          
    14                                  INCLUDE "graphics/grafix.inc"
../../graphics/grafix.inc:
     1                          ;
     2                          ;       Z88 Graphics Functions - Small C+ stubbs
     3                          ;
     4                          ;       Written around the Interlogic Standard Library
     5                          ;
     6                          ;       Stubs Written by D Morris - 30/9/98
     7                          ;
     8                          ;
     9                          ;       Define for graphics and other standard library functions
    10                          ;       See also text/textgfx.inc and text6/textgfx.inc
    11                          ;
    12                          ;
    13                          ;    $Id: grafix.inc $
    14                          ;
    15                          
    16                          
    17                          IF FORti82
    18                              DEFINE gotgfx
    19                              defc row_bytes    = 12
    20                              defc maxx    = 96
    21                              defc maxy    = 64
    22                          ENDIF
    23                          
    24                          IF FORti83
    25                              DEFINE gotgfx
    26                              defc row_bytes    = 12
    27                              defc maxx    = 96
    28                              defc maxy    = 64
    29                          ENDIF
    30                          
    31                          IF FORti83p
    32                              DEFINE gotgfx
    33                              defc row_bytes    = 12
    34                              defc maxx    = 96
    35                              defc maxy    = 64
    36                          ENDIF
    37                          
    38                          IF FORti85
    39                              DEFINE gotgfx
    40                              defc row_bytes    = 16
    41                              defc maxx    = 128
    42                              defc maxy    = 64
    43                          ENDIF
    44                          
    45                          IF FORti86
    46                              DEFINE gotgfx
    47                              defc row_bytes    = 16
    48                              defc maxx    = 128
    49                              defc maxy    = 64
    50                          ENDIF
    51                          
    52                          IF FORpc6001
    53                              DEFINE gotgfx
    54                              defc maxx    = 256
    55                              defc maxy    = 192
    56                              defc blankch    = 0
    57                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
    58                              defc    WANT_swapgfxbk = 0
    59                          ENDIF
    60                          
    61                          IF FORpc88
    62                              DEFINE gotgfx
    63                              defc maxx    = 640
    64                              defc maxy    = 200
    65                              defc    WANT_swapgfxbk = 0
    66                          ENDIF
    67                          
    68                          IF FORvz
    69                              DEFINE gotgfx
    70                              IF BLOCKgfx
    71                                  defc maxx    = 64
    72                                        defc maxy    = 32
    73                              ELSE
    74                                  defc maxx    = 128
    75                                        defc maxy    = 64
    76                              ENDIF
    77                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
    78                              defc    WANT_swapgfxbk = 0
    79                          ENDIF
    80                          
    81                          IF FORg800
    82                              DEFINE gotgfx
    83                              defc maxx    = 143    ; display size of the PC-G850
    84                              defc maxy    = 47    ; (a different "getmaxy" is provided for G800 and smaller ones)
    85                          ENDIF
    86                          
    87                          IF FORh19
    88                              DEFINE gotgfx
    89                              defc maxx    = 80
    90                              defc maxy    = 72
    91                              defc    WANT_swapgfxbk = 0
    92                          ENDIF
    93                          
    94                          IF FORabc80
    95                              DEFINE gotgfx
    96                              defc maxx    = 78
    97                              defc maxy    = 72
    98                          ENDIF
    99                          
   100                          IF FORbee
   101                              DEFINE gotgfx
   102                              defc maxx    = 160
   103                              defc maxy    = 75
   104                              defc blankch    = 128
   105                          ENDIF
   106                          
   107                          IF FORbeehr
   108                              DEFINE gotgfx
   109                              defc maxx    = 640
   110                              defc maxy    = 275
   111                          ENDIF
   112                          
   113                          IF FORbeehr320
   114                              DEFINE gotgfx
   115                              defc maxx    = 320
   116                              defc maxy    = 275
   117                          ENDIF
   118                          
   119                          IF FORbeehr512
   120                              DEFINE gotgfx
   121                              defc maxx    = 512
   122                              defc maxy    = 256
   123                          ENDIF
   124                          
   125                          IF FORgemini
   126                              DEFINE gotgfx
   127                              defc maxx    = 160
   128                              defc maxy    = 75
   129                              defc blankch    = 128
   130                          ENDIF
   131                          
   132                          IF FORgeminihr
   133                              DEFINE gotgfx
   134                              defc maxx    = 256
   135                              defc maxy    = 256
   136                              defc blankch    = 128
   137                          ENDIF
   138                          
   139                          IF FORzx80
   140                              DEFINE gotgfx
   141                              defc maxx    = 64
   142                              defc maxy    = 48
   143                          ENDIF
   144                          
   145                          IF FORzx81
   146                              DEFINE gotgfx
   147                              defc maxx    = 64
   148                              defc maxy    = 48
   149                              defc blankch    = 0
   150                          ENDIF
   151                          
   152                          IF FORlambda
   153                              DEFINE gotgfx
   154                              defc maxx    = 64
   155                              defc maxy    = 48
   156                              defc blankch    = 0
   157                          ENDIF
   158                          
   159                          IF FORzx81udg
   160                              DEFINE gotgfx
   161                              defc maxx    = 64
   162                              defc maxy    = 71
   163                              defc blankch    = 0
   164                          ENDIF
   165                          
   166                          IF FORzx81phrg
   167                              DEFINE gotgfx
   168                              defc maxx    = 128
   169                              defc maxy    = 96    ; This one can be changed !  1..200 are theorical valid values !
   170                          ENDIF
   171                          
   172                          IF FORzx81hr64
   173                              DEFINE gotgfx
   174                              defc maxx    = 256
   175                              defc maxy    = 64
   176                          ENDIF
   177                          
   178                          IF FORzx81hr192
   179                              DEFINE gotgfx
   180                              defc maxx    = 256
   181                              defc maxy    = 192
   182                          ENDIF
   183                          
   184                          IF FORzx81mt64
   185                              DEFINE gotgfx
   186                              defc maxx    = 248
   187                              defc maxy    = 64
   188                          ENDIF
   189                          
   190                          IF FORzx81mt192
   191                              DEFINE gotgfx
   192                              defc maxx    = 248
   193                              defc maxy    = 192
   194                          ENDIF
   195                          
   196                          IF FORzx81g007
   197                              DEFINE gotgfx
   198                              defc maxx    = 256    ; It could be 272 but we should switch to 'wide' mode
   199                              defc maxy    = 185
   200                          ENDIF
   201                          
   202                          IF FORaceudg
   203                              DEFINE gotgfx
   204                              defc maxx    = 64
   205                              defc maxy    = 72
   206                              defc blankch    = 32
   207                              defc    WANT_swapgfxbk = 0
   208                          ENDIF
   209                          
   210                          IF FORace
   211                              DEFINE gotgfx
   212                              defc maxx    = 64
   213                              defc maxy    = 48
   214                              defc blankch    = 32
   215                              defc    WANT_swapgfxbk = 0
   216                          ENDIF
   217                          
   218                          IF FORkaypro
   219                              DEFINE gotgfx
   220                              defc maxx    = 160
   221                              defc maxy    = 100
   222                          ENDIF
   223                          
   224                          IF FORbondwell
   225                              DEFINE gotgfx
   226                              defc maxx    = 160
   227                              defc maxy    = 75
   228                              defc    WANT_swapgfxbk = 0
   229                          ENDIF
   230                          
   231                          IF FORbondwell2
   232                              DEFINE gotgfx
   233                              defc maxx    = 640
   234                              defc maxy    = 200
   235                          ENDIF
   236                          
   237                          IF FORkaypro83
   238                              DEFINE gotgfx
   239                              defc maxx    = 80
   240                              defc maxy    = 50
   241                          ENDIF
   242                          
   243                          IF FORosborne1
   244                              DEFINE gotgfx
   245                              defc maxx    = 104
   246                              defc maxy    = 48
   247                              defc blankch    = 32
   248                          ENDIF
   249                          
   250                          IF FORzx
   251                           IF !FORts2068
   252                              DEFINE gotgfx
   253                              defc maxx    = 256
   254                              defc maxy    = 192
   255                              defc    WANT_swapgfxbk = 0
   256                           ENDIF
   257                          ENDIF
   258                          
   259                          IF FORcpc
   260                              DEFINE gotgfx
   261                              defc maxx    = 640
   262                              defc maxy    = 200
   263                              defc    WANT_swapgfxbk = 0
   264                          ENDIF
   265                          
   266                          IF FORpcw
   267                              DEFINE gotgfx
   268                              defc maxx    = 720
   269                              defc maxy    = 256
   270                          ENDIF
   271                          
   272                          IF FOReinstein
   273                              DEFINE gotgfx
   274                              defc maxx    = 256
   275                              defc maxy    = 192
   276                              defc fcolor    = 1
   277                              defc    WANT_swapgfxbk = 0
   278                          ENDIF
   279                          
   280                          IF FORmbc200
   281                              DEFINE gotgfx
   282                              defc maxx    = 640
   283                              defc maxy    = 400
   284                          ENDIF
   285                          
   286                          IF FORv1050
   287                              DEFINE gotgfx
   288                              defc maxx    = 640
   289                              defc maxy    = 300
   290                          ENDIF
   291                          
   292                          IF FORmsx
   293                              DEFINE gotgfx
   294                              defc maxx    = 256
   295                              defc maxy    = 192
   296                              defc fcolor    = 1
   297                              defc    WANT_swapgfxbk = 0
   298                          ENDIF
   299                          
   300                          IF FORmz
   301                              DEFINE gotgfx
   302                              defc maxx    = 80
   303                              defc maxy    = 50
   304                              defc    WANT_swapgfxbk = 0
   305                          ENDIF
   306                          
   307                          IF FORattache
   308                              DEFINE gotgfx
   309                              defc maxx    = 320
   310                              defc maxy    = 240
   311                              defc    WANT_swapgfxbk = 0
   312                          ENDIF
   313                          
   314                          IF FORsvi
   315                              DEFINE gotgfx
   316                              defc maxx    = 256
   317                              defc maxy    = 192
   318                              defc fcolor    = 1
   319                              defc    WANT_swapgfxbk = 0
   320                          ENDIF
   321                          
   322                          IF FORsam
   323                              DEFINE gotgfx
   324                              defc maxx    = 512
   325                              defc maxy    = 192
   326                              defc    WANT_swapgfxbk = 0
   327                          ENDIF
   328                          
   329                          IF FORoz
   330                              DEFINE gotgfx
   331                              defc row_bytes    = 30
   332                              defc maxx    = 239
   333                              defc maxy    = 80
   334                          ENDIF
   335                          
   336                          IF FORosca
   337                              DEFINE gotgfx
   338                              defc maxx    = 320
   339                              defc maxy    = 200
   340                              ; untested 240 lines resolution, see 'libsrc/graphics/osca'
   341                              ;defc maxy    = 240
   342                          ENDIF
   343                          
   344                          IF FORc128hr
   345                              DEFINE gotgfx
   346                              defc maxx    = 640
   347                              defc maxy    = 200
   348                          ENDIF
   349                          
   350                          IF FORc128hr480
   351                              DEFINE gotgfx
   352                              defc maxx    = 640
   353                              defc maxy    = 480
   354                          ENDIF
   355                          
   356                          IF FORts2068
   357                              DEFINE gotgfx
   358                              defc maxx       = 512
   359                              defc maxy       = 192
   360                              defc    WANT_swapgfxbk = 0
   361                          ENDIF
   362                          
   363                          IF FORzxn
   364                              DEFINE gotgfx
   365                              defc maxx       = 512
   366                              defc maxy       = 192
   367                              defc    WANT_swapgfxbk = 0
   368                          ENDIF
   369                          
   370                          IF FORtiki100
   371                              DEFINE gotgfx
   372                              defc maxx       = 1024
   373                              defc maxy       = 256
   374                          ENDIF
   375                          
   376                          IF FORenterprise
   377                              DEFINE gotgfx
   378                              defc maxx       = 336
   379                              defc maxy       = 243
   380                          ENDIF
   381                          
   382                          IF FORenterprisehr
   383                              DEFINE gotgfx
   384                              defc maxx       = 672
   385                              defc maxy       = 243
   386                          ENDIF
   387                          
   388                          IF FORz88
   389                              DEFINE gotgfx
   390                              defc    maxx    = 256
   391                              defc    maxy     = 64
   392                          ENDIF
   393                          
   394                          IF FORz9001
   395                              DEFINE gotgfx
   396                              defc maxx    = 320
   397                              defc maxy    = 192
   398                              defc    WANT_swapgfxbk = 0
   399                              defc blankch = 32
   400                          ENDIF
   401                          
   402                          IF FORkc
   403                              DEFINE gotgfx
   404                              defc maxx    = 320
   405                              defc maxy    = 256
   406                          ENDIF
   407                          
   408                          IF FORaussie
   409                              DEFINE gotgfx
   410                              defc maxx    = 640
   411                              defc maxy    = 576
   412                          ENDIF
   413                          
   414                          IF FORaquarius
   415                              DEFINE gotgfx
   416                              defc maxx    = 80
   417                              defc maxy    = 72
   418                              defc blankch    = 160
   419                          ENDIF
   420                          
   421                          IF FORaqplus
   422                              DEFINE gotgfx
   423                              defc maxx    = 320
   424                              defc maxy    = 299
   425                          ENDIF
   426                          
   427                          IF FORaq48
   428                              DEFINE gotgfx
   429                              defc maxx    = 80
   430                              defc maxy    = 48
   431                              defc blankch    = 160
   432                          ENDIF
   433                          
   434                          IF FORz1013
   435                              DEFINE gotgfx
   436                              defc maxx    = 256
   437                              defc maxy    = 256
   438                              defc    WANT_swapgfxbk = 0
   439                          ENDIF
   440                          
   441                          
   442                          IF FORc128
   443                              DEFINE gotgfx
   444                              defc maxx    = 80
   445                              defc maxy    = 50
   446                              defc blankch    = 32
   447                          ENDIF
   448                          
   449                          IF FORc128udg
   450                              DEFINE gotgfx
   451                              defc maxx    = 80
   452                              defc maxy    = 75
   453                              defc blankch    = 0
   454                          ENDIF
   455                          
   456                          IF FORfp1100
   457                              DEFINE gotgfx
   458                              defc maxx    = 640
   459                              defc maxy    = 200
   460                              defc blankch    = 32
   461                              defc USEplotc   = 1
   462                              defc    WANT_swapgfxbk = 0
   463                          ENDIF
   464                          
   465                          IF FORgal
   466                              DEFINE gotgfx
   467                              ; This size reflects the Gal+ screen mode
   468                                  IF textgraphics
   469                                      defc maxx    = 64
   470                                  defc maxy    = 48
   471                                  ELSE
   472                                      defc maxx    = 256
   473                                  defc maxy    = 208
   474                                  ENDIF
   475                              defc blankch    = 32
   476                              defc    WANT_swapgfxbk = 0
   477                          ENDIF
   478                          
   479                          IF FORnascom
   480                              DEFINE gotgfx
   481                              defc maxx    = 96
   482                              defc maxy    = 48
   483                              defc blankch    = 32
   484                          ENDIF
   485                          
   486                          IF FORtrs80
   487                              DEFINE gotgfx
   488                              defc maxx    = 128
   489                              defc maxy    = 48
   490                              defc blankch    = 128
   491                              defc    WANT_swapgfxbk = 0
   492                          ENDIF
   493                          
   494                          IF FORtrs80m2
   495                              DEFINE gotgfx
   496                              defc maxx    = 80
   497                              defc maxy    = 72
   498                              defc blankch    = 32
   499                              defc GFXTEXT3 = 1
   500                          ENDIF
   501                          
   502                          IF FORtrs80m4
   503                              DEFINE gotgfx
   504                              defc maxx    = 160
   505                              defc maxy    = 72
   506                              defc blankch    = 128
   507                          ENDIF
   508                          
   509                          IF FOReg2000
   510                              DEFINE gotgfx
   511                              defc maxx    = 160
   512                              defc maxy    = 102
   513                          ENDIF
   514                          
   515                          IF FORhrg1
   516                              DEFINE gotgfx
   517                              defc maxx    = 384
   518                              defc maxy    = 192
   519                          ENDIF
   520                          
   521                          IF FORgrafyx3
   522                              DEFINE gotgfx
   523                              defc maxx    = 512
   524                              defc maxy    = 192
   525                          ENDIF
   526                          
   527                          IF FORgrafyx4
   528                              DEFINE gotgfx
   529                              defc maxx    = 640
   530                              defc maxy    = 240
   531                          ENDIF
   532                          
   533                          IF FORp2000
   534                              DEFINE gotgfx
   535                              defc maxx    = 78
   536                              defc maxy    = 72
   537                              defc blankch    = 0
   538                          ENDIF
   539                          
   540                          IF FORpx4
   541                              DEFINE gotgfx
   542                              defc maxx    = 240
   543                              defc maxy    = 64
   544                          ENDIF
   545                          
   546                          IF FORpx8
   547                              DEFINE gotgfx
   548                              defc maxx    = 480
   549                              defc maxy    = 64
   550                          ENDIF
   551                          
   552                          IF FORnc100
   553                              DEFINE gotgfx
   554                              defc maxx    = 480
   555                              defc maxy    = 64
   556                          ENDIF
   557                          
   558                          IF FORnc200
   559                              DEFINE gotgfx
   560                              defc maxx    = 480
   561                              defc maxy    = 128
   562                          ENDIF
   563                          
   564                          IF FORvg5k
   565                              DEFINE gotgfx
   566                              defc maxx    = 80
   567                              defc maxy    = 75
   568                              defc blankch    = 0
   569                              defc    WANT_swapgfxbk = 0
   570                          ENDIF
   571                          
   572                          IF FORsorcerer
   573                              DEFINE gotgfx
   574                              defc maxx    = 128
   575                              defc maxy    = 60
   576                              defc blankch    = 32
   577                          ENDIF
   578                          
   579                          IF FORpacman
   580                              DEFINE gotgfx
   581                              defc maxx    = 84
   582                              defc maxy    = 72
   583                              defc blankch    = 192
   584                          ENDIF
   585                          
   586                          IF FORpv1000
   587                              DEFINE gotgfx
   588                              defc maxx    = 56
   589                              defc maxy    = 48
   590                              defc    WANT_swapgfxbk = 0
   591                          ENDIF
   592                          
   593                          IF FORalphatro
   594                              DEFINE gotgfx
   595                              defc maxx    = 160
   596                              defc maxy    = 72
   597                              defc blankch    = 32
   598                              defc    WANT_swapgfxbk = 0
   599                          ENDIF
   600                          
   601                          IF FORhemc
   602                              DEFINE gotgfx
   603                              defc maxx    = 64        ;Text graphics settings
   604                              defc maxy    = 24
   605                              defc blankch    = 32
   606                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   607                              defc    WANT_swapgfxbk = 0
   608                          ENDIF
   609                          
   610                          IF FORhgmc
   611                              DEFINE    gotgfx
   612                              defc    maxx = 256
   613                              defc    maxy = 256
   614                              defc    WANT_swapgfxbk = 0
   615                              defc    BITS_reversed = 1
   616                          ENDIF
   617                          
   618                          
   619                          IF FORspc1000
   620                              DEFINE gotgfx
   621                              ;defc maxx    = 64        ;Text graphics settings
   622                              ;defc maxy    = 48
   623                              defc maxx    = 256        ;Graphics/VDP
   624                              defc maxy    = 192
   625                              defc blankch    = 32
   626                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   627                              defc    WANT_swapgfxbk = 0
   628                          ENDIF
   629                          
   630                          IF FORsmc777
   631                              DEFINE gotgfx
   632                              defc maxx    = 640
   633                              defc maxy    = 200
   634                              defc    WANT_swapgfxbk = 0
   635                          ENDIF
   636                          
   637                          IF FORmulti8
   638                              DEFINE gotgfx
   639                              defc maxx    = 640
   640                              defc maxy    = 200
   641                              defc    WANT_swapgfxbk = 0
   642                          ENDIF
   643                          
   644                          IF FORrx78
   645                              DEFINE gotgfx
   646                              defc maxx    = 192
   647                              defc maxy    = 184
   648                              defc    WANT_swapgfxbk = 0
   649                          ENDIF
   650                          
   651                          IF FORlynx
   652                              DEFINE gotgfx
   653                              defc maxx    = 64        ;Text graphics settings
   654                              defc maxy    = 64
   655                              defc blankch    = 0
   656                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   657                              defc    WANT_swapgfxbk = 0
   658                          ENDIF
   659                          
   660                          IF FORx1
   661                              DEFINE gotgfx
   662                              defc maxx    = 640
   663                              defc maxy    = 200
   664                              defc    WANT_swapgfxbk = 0
   665                          ENDIF
   666                          
   667                          IF FORlaser500
   668                              DEFINE gotgfx
   669                              defc maxx = 320
   670                              defc maxy = 192
   671                              defc blankch = 32
   672                              defc    WANT_swapgfxbk = 0
   673                          ENDIF
   674                          
   675                          IF FORexcali64
   676                              DEFINE gotgfx
   677                              defc maxx = 160
   678                              defc maxy = 72
   679                              defc blankch = 32
   680                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   681                              defc USEindex = 1
   682                              defc    WANT_swapgfxbk = 0
   683                          ENDIF
   684                          
   685                          IF FORz80tvgame
   686                              DEFINE gotgfx
   687                              defc maxx = 168
   688                              defc maxy = 208
   689                              defc blankch = 32
   690                              defc    WANT_swapgfxbk = 0
   691                          ENDIF
   692                          
   693                          IF FORsv8000
   694                              DEFINE gotgfx
   695                              defc maxx = 256
   696                              defc maxy = 96
   697                              defc blankch = 32
   698                              defc    WANT_swapgfxbk = 0
   699                          ENDIF
   700                          
   701                          IF FORpmd85
   702                              DEFINE gotgfx
   703                              defc maxx = 288
   704                              defc maxy = 256
   705                              defc blankch = 32
   706                              defc    WANT_swapgfxbk = 0
   707                          ENDIF
   708                          
   709                          IF FORm100
   710                              DEFINE gotgfx
   711                              defc maxx = 240
   712                              defc maxy = 64
   713                          ENDIF
   714                          
   715                          IF FORvector06c
   716                              DEFINE gotgfx
   717                              defc maxx = 256
   718                              defc maxy = 256
   719                              defc blankch = 32
   720                              defc    WANT_swapgfxbk = 0
   721                          ENDIF
   722                          
   723                          IF FORspecial
   724                              DEFINE gotgfx
   725                              defc maxx = 384
   726                              defc maxy = 256
   727                              defc blankch = 32
   728                              defc    WANT_swapgfxbk = 0
   729                          ENDIF
   730                          
   731                          IF FORhomelab
   732                              DEFINE gotgfx
   733                              defc maxx = 128
   734                              defc maxy = 64
   735                              defc    WANT_swapgfxbk = 0
   736                          ENDIF
   737                          
   738                          IF FORhomelab2
   739                              DEFINE gotgfx
   740                              defc maxx = 80
   741                              defc maxy = 50
   742                              defc    WANT_swapgfxbk = 0
   743                          ENDIF
   744                          
   745                          IF FORgb
   746                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   747                              defc    WANT_swapgfxbk = 0
   748                          ENDIF
   749                          
   750                          IF FORmikro80
   751                              defc USEplotc = 1
   752                              defc    WANT_swapgfxbk = 0
   753                          ENDIF
   754                          
   755                          IF FORondra
   756                              DEFINE gotgfx
   757                              defc maxx    = 320
   758                              defc maxy    = 256
   759                              defc    WANT_swapgfxbk = 0
   760                          ENDIF
   761                          
   762                          IF FORlviv
   763                              DEFINE gotgfx
   764                              defc maxx    = 256
   765                              defc maxy    = 256
   766                              defc    WANT_swapgfxbk = 0
   767                          ENDIF
   768                          
   769                          IF FORvti
   770                              DEFINE gotgfx
   771                              defc maxx    = 128
   772                              defc maxy    = 48
   773                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   774                              defc blankch    = 160
   775                              defc    WANT_swapgfxbk = 0
   776                          ENDIF
   777                          
   778                          IF FORvio
   779                              DEFINE gotgfx
   780                              defc maxx    = 160
   781                              defc maxy    = 72
   782                              defc blankch    = 32
   783                              defc    WANT_swapgfxbk = 0
   784                          ENDIF
   785                          
   786                          IF FORvdm
   787                              DEFINE gotgfx
   788                              defc maxx    = 64
   789                              defc maxy    = 16
   790                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   791                              defc    WANT_swapgfxbk = 0
   792                          ENDIF
   793                          
   794                          IF FORkrokha
   795                              DEFINE gotgfx
   796                              defc maxx    = 96
   797                              defc maxy    = 64
   798                              defc    WANT_swapgfxbk = 0
   799                          ENDIF
   800                          
   801                          IF FORgl6000
   802                              DEFINE gotgfx
   803                              defc maxx    = 240
   804                              defc maxy    = 100
   805                              defc    WANT_swapgfxbk = 0
   806                          ENDIF
   807                          
   808                          IF FORsol20
   809                              DEFINE gotgfx
   810                              defc maxx    = 64
   811                              defc maxy    = 16
   812                              defc USEplotc = 1
   813                          ENDIF
   814                          
   815                          ; GSX virtual window is (32768 x 32768)
   816                          ; HiRez display should stay between 512..800 px.
   817                          ; We keep an average value
   818                          IF FORcpm
   819                            IF FORgsx
   820                              DEFINE gotgfx
   821                              defc maxx    = 1920        ; foo value hopefully larger than the max X resolution
   822                              defc maxy    = 768        ; we keep unbalanced proportions, assuming non-square pixels
   823                            ENDIF
   824                          ENDIF
   825                          
   826                          ; =============================================
   827                          
   828                          IF FORtek
   829                             DEFINE gotgfx
   830                             defc maxx = 1024
   831                             defc maxy = 768
   832                             defc    WANT_swapgfxbk = 0
   833                          ENDIF
   834                          
   835                          IF FORregis
   836                             DEFINE gotgfx
   837                             defc maxx = 768
   838                             defc maxy = 480
   839                          ENDIF
   840                          
   841                          IF FORagon
   842                             DEFINE gotgfx
   843                             defc maxx = 1024
   844                             defc maxy = 768
   845                             defc    WANT_swapgfxbk = 0
   846                          ENDIF
   847                          
   848                          IF FORtim011
   849                             DEFINE gotgfx
   850                             defc maxx = 512
   851                             defc maxy = 256
   852                             defc    WANT_swapgfxbk = 0
   853                          ENDIF
   854                          
   855                          ; Catch all to sort things out
   856                          
   857                          IF !gotgfx
   858                              defc    maxx = 256
   859                              defc    maxy = 192
   860                          ENDIF
   861                          
   862                          IF WANT_swapgfxbk
   863                              defc    NEED_swapgfxbk = 0
   864                          ELSE
   865                              defc    NEED_swapgfxbk = 1
   866                          ENDIF
   867                          
   868                          
   869                          
   870                          ;       Structure for open window       struct *window
   871                          
   872                          DEFVARS 0
   873                          {
   874                                  windnum ds.b    1
   875                                  wind_x  ds.b    1
   876                                  wind_y  ds.b    1
   877                                  wind_w  ds.b    1       ;width/map width
   878                                  wind_d  ds.b    1       ;
   879                                  type    ds.b    1       ;
   880                                  graph   ds.b    1       ;0=text 1=graphics
   881                          }
   882                          
stencil_render.asm:
    15                          
    16                            IF    !__CPU_INTEL__&!__CPU_GBZ80__
    17                                  SECTION smc_clib
    18                                  PUBLIC  stencil_render
    19                                  PUBLIC  _stencil_render
    20                                  EXTERN  dither_pattern
    21                          
    22                                  EXTERN  swapgfxbk
    23                                  EXTERN  pixeladdress
    24                                  EXTERN  leftbitmask, rightbitmask
    25                                  EXTERN  swapgfxbk1
    26                                  EXTERN  __graphics_end
    27                          
    28                          ;
    29                          ;    $Id: stencil_render.asm,v 1.8 2016-04-22 20:29:52 dom Exp $
    30                          ;
    31                          
    32                          stencil_render:
    33                          _stencil_render:
    34                                  push    ix
    35                                  ld      ix, 4
    36                                  add     ix, sp
    37                          
    38                              IF  NEED_swapgfxbk=1
    39                                  call    swapgfxbk
    40                              ENDIF
    41                                  ld      bc, __graphics_end
    42                                  push    bc
    43                          
    44                              IF  maxy<>256
    45                                  ld      c, maxy
    46                              ELSE
    47                                  ld      c, 0
    48                              ENDIF
    49                                  push    bc
    50                          yloop:  pop     bc
    51                                  dec     c
    52                              ;jp    z,swapgfxbk1
    53                                  ret     z
    54                                  push    bc
    55                          
    56                                  ld      d, 0
    57                                  ld      e, c
    58                          
    59                                  ld      l, (ix+2)               ; stencil
    60                                  ld      h, (ix+3)
    61                                  add     hl, de
    62                                  ld      a, (hl)                 ;X1
    63                          
    64                          
    65                              IF  maxy<>256
    66                                  ld      e, maxy
    67                                  add     hl, de
    68                              ELSE
    69                                  ld      e, 0
    70                                  inc     h
    71                              ENDIF
    72                                  cp      (hl)                    ; if x1>x2, return
    73                                  jr      nc, yloop
    74                          
    75                                 ; C still holds Y
    76                                  push    af                      ; X1
    77                                  ld      a, (hl)
    78                                  ld      b, a                    ; X2
    79                          
    80                                  ld      a, (ix+0)               ; intensity
    81                                  call    dither_pattern
    82                                  ld      (pattern1+1), a
    83                                  ld      (pattern2+1), a
    84                          
    85                                  pop     af
    86                                  ld      h, a                    ; X1
    87                                  ld      l, c                    ; Y
    88                          
    89                                  push    bc
    90                                  call    pixeladdress            ; bitpos0 = pixeladdress(x,y)
    91                                  call    leftbitmask             ; LeftBitMask(bitpos0)
    92                                  pop     bc
    93                                  push    de
    94                          
    95                                  ld      h, d
    96                                  ld      l, e
    97                          
    98                                  call    mask_pattern
    99                                  push    af
   100                              ;ld    (hl),a
   101                          
   102                                  ld      h, b                    ; X2
   103                                  ld      l, c                    ; Y
   104                          
   105                                  call    pixeladdress            ; bitpos1 = pixeladdress(x+width-1,y)
   106                                  call    rightbitmask            ; RightBitMask(bitpos1)
   107                                  ld      (bitmaskr+1), a         ; bitmask1 = LeftBitMask(bitpos0)
   108                          
   109                                  pop     af                      ; pattern to be drawn (left-masked)
   110                                  pop     hl                      ; adr0
   111                                  push    hl
   112                                  ex      de, hl
   113                                  and     a
   114                                  sbc     hl, de
   115                          
   116                                  jr      z, onebyte              ; area is within the same address...
   117                          
   118                                  ld      b, l                    ; number of full bytes in a row
   119                                  pop     hl
   120                          
   121                              ;ld    de,8
   122                          
   123                                  ld      (hl), a                 ; (offset) = (offset) AND bitmask0
   124                          
   125                              ;add    hl,de
   126                                  inc     hl                      ; offset += 1 (8 bits)
   127                          
   128                          pattern2:
   129                                  ld      a, 0
   130                                  dec     b
   131                                  jr      z, bitmaskr
   132                          
   133                          fill_row_loop:                          ; do
   134                                  ld      (hl), a                 ; (offset) = pattern
   135                              ;add    hl,de
   136                                  inc     hl                      ; offset += 1 (8 bits)
   137                                  djnz    fill_row_loop           ; while ( r-- != 0 )
   138                          
   139                          
   140                          bitmaskr:
   141                                  ld      a, 0
   142                                  call    mask_pattern
   143                                  ld      (hl), a
   144                          
   145                                  jr      yloop
   146                          
   147                          
   148                          onebyte:
   149                                  pop     hl
   150                                  ld      (pattern1+1), a
   151                                  jr      bitmaskr
   152                          
   153                          
   154                              ; Prepare an edge byte, basing on the byte mask in A
   155                              ; and on the pattern being set in (pattern1+1)
   156                          mask_pattern:
   157                              IF  BITS_reversed
   158                                  xor     255
   159                              ENDIF
   160                                  ld      d, a                    ; keep a copy of mask
   161                                  and     (hl)                    ; mask data on screen
   162                                  ld      e, a                    ; save masked data
   163                                  ld      a, d                    ; retrieve mask
   164                                  cpl                             ; invert it
   165                          pattern1:
   166                                  and     0                       ; prepare fill pattern portion
   167                                  or      e                       ; mix with masked data
   168                                  ret
   169                            ENDIF
   170                          
