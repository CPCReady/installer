/tmp/tmpXXnO03yY.asm:
     1                          MODULE bkrestore3_asm
     2                          LINE 0, "bkrestore3.asm"
bkrestore3.asm:
                                
     1                          ;
     2                          ;    Fast background save
     3                          ;
     4                          ;    Generic version (just a bit slow)
     5                          ;
     6                          ;    $Id: bkrestore3.asm $
     7                          ;
     8                          
     9                            IF    !__CPU_INTEL__&!__CPU_GBZ80__
    10                                  SECTION code_clib
    11                          
    12                          
    13                                  EXTERN  plotpixel
    14                                  EXTERN  respixel
    15                          
    16                                  PUBLIC  bkrestore
    17                                  PUBLIC  _bkrestore
    18                                  PUBLIC  bkrestore_fastcall
    19                                  PUBLIC  _bkrestore_fastcall
    20                          
    21                          bkrestore:
    22                          _bkrestore:
    23                                  pop     de
    24                                  pop     hl
    25                                  push    hl
    26                                  push    de
    27                          
    28                          bkrestore_fastcall:
    29                          _bkrestore_fastcall:
    30                          
    31                              ; __FASTCALL__ !!   HL = sprite address
    32                          
    33                                  push    ix
    34                          
    35                                  inc     hl                      ; skip first X xs
    36                                  inc     hl                      ; skip first Y ys
    37                          
    38                                  ld      d, (hl)                 ; x pos
    39                                  inc     hl
    40                                  ld      e, (hl)                 ; Y pos
    41                                  inc     hl
    42                          
    43                                  push    hl                      ; sprite addr
    44                                  pop     ix
    45                          
    46                          ;    ld    h,a    ; X
    47                          ;    ld    l,e    ; Y
    48                          
    49                                  ld      h, d
    50                                  ld      l, e
    51                          
    52                                  ld      a, (ix+0)               ; Width
    53                                  ld      b, (ix+1)               ; Height
    54                          oloopx: push    bc                      ;Save # of rows
    55                                  push    af
    56                          
    57                              ;ld    b,a    ;Load width
    58                                  ld      b, 0                    ; Better, start from zero !!
    59                          
    60                                  ld      c, (ix+2)               ;Load one line of image
    61                          
    62                          iloopx:                                 ;sla    c    ;Test leftmost pixel
    63                              ;jr    nc,noplotx    ;See if a plot is needed
    64                          
    65                                  push    hl
    66                              ;push    bc    ; this should be done by the called routine
    67                                  push    de
    68                                  ld      a, h
    69                                  add     a, b
    70                                  ld      h, a
    71                                  sla     c                       ;Test leftmost pixel
    72                                  push    af
    73                                  call    nc, respixel
    74                                  pop     af
    75                                  call    c, plotpixel
    76                                  pop     de
    77                              ;pop    bc
    78                                  pop     hl
    79                          
    80                          ;.noplotx
    81                          
    82                                  inc     b                       ; witdh counter
    83                          
    84                                  pop     af
    85                                  push    af
    86                          
    87                                  cp      b                       ; end of row ?
    88                          
    89                                  jr      nz, noblkx
    90                          
    91                                  inc     ix
    92                                  ld      c, (ix+2)               ;Load next byte of image
    93                          
    94                                  jr      noblockx
    95                          
    96                          noblkx:
    97                          
    98                                  ld      a, b                    ; next byte in row ?
    99                              ;dec    a
   100                                  and     a
   101                                  jr      z, iloopx
   102                                  and     7
   103                          
   104                                  jr      nz, iloopx
   105                          
   106                          blockx:
   107                                  inc     ix
   108                                  ld      c, (ix+2)               ;Load next byte of image
   109                                  jr      iloopx
   110                          
   111                          noblockx:
   112                          
   113                                  inc     l
   114                          
   115                                  pop     af
   116                                  pop     bc                      ;Restore data
   117                                  djnz    oloopx
   118                          
   119                                  pop     ix
   120                                  ret
   121                          
   122                          
   123                            ENDIF
   124                          
