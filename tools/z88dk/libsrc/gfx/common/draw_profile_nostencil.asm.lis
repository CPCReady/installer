/tmp/tmpXX3eWXsu.asm:
     1                          MODULE draw_profile_nostencil_asm
     2                          LINE 0, "draw_profile_nostencil.asm"
draw_profile_nostencil.asm:
                                
     1                          ;
     2                          ;      Z88DK Graphics Functions
     3                          ;
     4                          ;      Draw a "gfx profile" metadata stream - Stefano Bodrato 16/10/2009
     5                          ;
     6                          ;    void draw_profile(int dx, int dy, int scale, unsigned char *metapic);
     7                          ;
     8                          ;	$Id: draw_profile_nostencil.asm,v 1.3 2016-04-22 20:17:17 dom Exp $
     9                          ;
    10                          
    11                          
    12                                  INCLUDE "graphics/grafix.inc"
../../graphics/grafix.inc:
     1                          ;
     2                          ;       Z88 Graphics Functions - Small C+ stubbs
     3                          ;
     4                          ;       Written around the Interlogic Standard Library
     5                          ;
     6                          ;       Stubs Written by D Morris - 30/9/98
     7                          ;
     8                          ;
     9                          ;       Define for graphics and other standard library functions
    10                          ;       See also text/textgfx.inc and text6/textgfx.inc
    11                          ;
    12                          ;
    13                          ;    $Id: grafix.inc $
    14                          ;
    15                          
    16                          
    17                          IF FORti82
    18                              DEFINE gotgfx
    19                              defc row_bytes    = 12
    20                              defc maxx    = 96
    21                              defc maxy    = 64
    22                          ENDIF
    23                          
    24                          IF FORti83
    25                              DEFINE gotgfx
    26                              defc row_bytes    = 12
    27                              defc maxx    = 96
    28                              defc maxy    = 64
    29                          ENDIF
    30                          
    31                          IF FORti83p
    32                              DEFINE gotgfx
    33                              defc row_bytes    = 12
    34                              defc maxx    = 96
    35                              defc maxy    = 64
    36                          ENDIF
    37                          
    38                          IF FORti85
    39                              DEFINE gotgfx
    40                              defc row_bytes    = 16
    41                              defc maxx    = 128
    42                              defc maxy    = 64
    43                          ENDIF
    44                          
    45                          IF FORti86
    46                              DEFINE gotgfx
    47                              defc row_bytes    = 16
    48                              defc maxx    = 128
    49                              defc maxy    = 64
    50                          ENDIF
    51                          
    52                          IF FORpc6001
    53                              DEFINE gotgfx
    54                              defc maxx    = 256
    55                              defc maxy    = 192
    56                              defc blankch    = 0
    57                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
    58                              defc    WANT_swapgfxbk = 0
    59                          ENDIF
    60                          
    61                          IF FORpc88
    62                              DEFINE gotgfx
    63                              defc maxx    = 640
    64                              defc maxy    = 200
    65                              defc    WANT_swapgfxbk = 0
    66                          ENDIF
    67                          
    68                          IF FORvz
    69                              DEFINE gotgfx
    70                              IF BLOCKgfx
    71                                  defc maxx    = 64
    72                                        defc maxy    = 32
    73                              ELSE
    74                                  defc maxx    = 128
    75                                        defc maxy    = 64
    76                              ENDIF
    77                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
    78                              defc    WANT_swapgfxbk = 0
    79                          ENDIF
    80                          
    81                          IF FORg800
    82                              DEFINE gotgfx
    83                              defc maxx    = 143    ; display size of the PC-G850
    84                              defc maxy    = 47    ; (a different "getmaxy" is provided for G800 and smaller ones)
    85                          ENDIF
    86                          
    87                          IF FORh19
    88                              DEFINE gotgfx
    89                              defc maxx    = 80
    90                              defc maxy    = 72
    91                              defc    WANT_swapgfxbk = 0
    92                          ENDIF
    93                          
    94                          IF FORabc80
    95                              DEFINE gotgfx
    96                              defc maxx    = 78
    97                              defc maxy    = 72
    98                          ENDIF
    99                          
   100                          IF FORbee
   101                              DEFINE gotgfx
   102                              defc maxx    = 160
   103                              defc maxy    = 75
   104                              defc blankch    = 128
   105                          ENDIF
   106                          
   107                          IF FORbeehr
   108                              DEFINE gotgfx
   109                              defc maxx    = 640
   110                              defc maxy    = 275
   111                          ENDIF
   112                          
   113                          IF FORbeehr320
   114                              DEFINE gotgfx
   115                              defc maxx    = 320
   116                              defc maxy    = 275
   117                          ENDIF
   118                          
   119                          IF FORbeehr512
   120                              DEFINE gotgfx
   121                              defc maxx    = 512
   122                              defc maxy    = 256
   123                          ENDIF
   124                          
   125                          IF FORgemini
   126                              DEFINE gotgfx
   127                              defc maxx    = 160
   128                              defc maxy    = 75
   129                              defc blankch    = 128
   130                          ENDIF
   131                          
   132                          IF FORgeminihr
   133                              DEFINE gotgfx
   134                              defc maxx    = 256
   135                              defc maxy    = 256
   136                              defc blankch    = 128
   137                          ENDIF
   138                          
   139                          IF FORzx80
   140                              DEFINE gotgfx
   141                              defc maxx    = 64
   142                              defc maxy    = 48
   143                          ENDIF
   144                          
   145                          IF FORzx81
   146                              DEFINE gotgfx
   147                              defc maxx    = 64
   148                              defc maxy    = 48
   149                              defc blankch    = 0
   150                          ENDIF
   151                          
   152                          IF FORlambda
   153                              DEFINE gotgfx
   154                              defc maxx    = 64
   155                              defc maxy    = 48
   156                              defc blankch    = 0
   157                          ENDIF
   158                          
   159                          IF FORzx81udg
   160                              DEFINE gotgfx
   161                              defc maxx    = 64
   162                              defc maxy    = 71
   163                              defc blankch    = 0
   164                          ENDIF
   165                          
   166                          IF FORzx81phrg
   167                              DEFINE gotgfx
   168                              defc maxx    = 128
   169                              defc maxy    = 96    ; This one can be changed !  1..200 are theorical valid values !
   170                          ENDIF
   171                          
   172                          IF FORzx81hr64
   173                              DEFINE gotgfx
   174                              defc maxx    = 256
   175                              defc maxy    = 64
   176                          ENDIF
   177                          
   178                          IF FORzx81hr192
   179                              DEFINE gotgfx
   180                              defc maxx    = 256
   181                              defc maxy    = 192
   182                          ENDIF
   183                          
   184                          IF FORzx81mt64
   185                              DEFINE gotgfx
   186                              defc maxx    = 248
   187                              defc maxy    = 64
   188                          ENDIF
   189                          
   190                          IF FORzx81mt192
   191                              DEFINE gotgfx
   192                              defc maxx    = 248
   193                              defc maxy    = 192
   194                          ENDIF
   195                          
   196                          IF FORzx81g007
   197                              DEFINE gotgfx
   198                              defc maxx    = 256    ; It could be 272 but we should switch to 'wide' mode
   199                              defc maxy    = 185
   200                          ENDIF
   201                          
   202                          IF FORaceudg
   203                              DEFINE gotgfx
   204                              defc maxx    = 64
   205                              defc maxy    = 72
   206                              defc blankch    = 32
   207                              defc    WANT_swapgfxbk = 0
   208                          ENDIF
   209                          
   210                          IF FORace
   211                              DEFINE gotgfx
   212                              defc maxx    = 64
   213                              defc maxy    = 48
   214                              defc blankch    = 32
   215                              defc    WANT_swapgfxbk = 0
   216                          ENDIF
   217                          
   218                          IF FORkaypro
   219                              DEFINE gotgfx
   220                              defc maxx    = 160
   221                              defc maxy    = 100
   222                          ENDIF
   223                          
   224                          IF FORbondwell
   225                              DEFINE gotgfx
   226                              defc maxx    = 160
   227                              defc maxy    = 75
   228                              defc    WANT_swapgfxbk = 0
   229                          ENDIF
   230                          
   231                          IF FORbondwell2
   232                              DEFINE gotgfx
   233                              defc maxx    = 640
   234                              defc maxy    = 200
   235                          ENDIF
   236                          
   237                          IF FORkaypro83
   238                              DEFINE gotgfx
   239                              defc maxx    = 80
   240                              defc maxy    = 50
   241                          ENDIF
   242                          
   243                          IF FORosborne1
   244                              DEFINE gotgfx
   245                              defc maxx    = 104
   246                              defc maxy    = 48
   247                              defc blankch    = 32
   248                          ENDIF
   249                          
   250                          IF FORzx
   251                           IF !FORts2068
   252                              DEFINE gotgfx
   253                              defc maxx    = 256
   254                              defc maxy    = 192
   255                              defc    WANT_swapgfxbk = 0
   256                           ENDIF
   257                          ENDIF
   258                          
   259                          IF FORcpc
   260                              DEFINE gotgfx
   261                              defc maxx    = 640
   262                              defc maxy    = 200
   263                              defc    WANT_swapgfxbk = 0
   264                          ENDIF
   265                          
   266                          IF FORpcw
   267                              DEFINE gotgfx
   268                              defc maxx    = 720
   269                              defc maxy    = 256
   270                          ENDIF
   271                          
   272                          IF FOReinstein
   273                              DEFINE gotgfx
   274                              defc maxx    = 256
   275                              defc maxy    = 192
   276                              defc fcolor    = 1
   277                              defc    WANT_swapgfxbk = 0
   278                          ENDIF
   279                          
   280                          IF FORmbc200
   281                              DEFINE gotgfx
   282                              defc maxx    = 640
   283                              defc maxy    = 400
   284                          ENDIF
   285                          
   286                          IF FORv1050
   287                              DEFINE gotgfx
   288                              defc maxx    = 640
   289                              defc maxy    = 300
   290                          ENDIF
   291                          
   292                          IF FORmsx
   293                              DEFINE gotgfx
   294                              defc maxx    = 256
   295                              defc maxy    = 192
   296                              defc fcolor    = 1
   297                              defc    WANT_swapgfxbk = 0
   298                          ENDIF
   299                          
   300                          IF FORmz
   301                              DEFINE gotgfx
   302                              defc maxx    = 80
   303                              defc maxy    = 50
   304                              defc    WANT_swapgfxbk = 0
   305                          ENDIF
   306                          
   307                          IF FORattache
   308                              DEFINE gotgfx
   309                              defc maxx    = 320
   310                              defc maxy    = 240
   311                              defc    WANT_swapgfxbk = 0
   312                          ENDIF
   313                          
   314                          IF FORsvi
   315                              DEFINE gotgfx
   316                              defc maxx    = 256
   317                              defc maxy    = 192
   318                              defc fcolor    = 1
   319                              defc    WANT_swapgfxbk = 0
   320                          ENDIF
   321                          
   322                          IF FORsam
   323                              DEFINE gotgfx
   324                              defc maxx    = 512
   325                              defc maxy    = 192
   326                              defc    WANT_swapgfxbk = 0
   327                          ENDIF
   328                          
   329                          IF FORoz
   330                              DEFINE gotgfx
   331                              defc row_bytes    = 30
   332                              defc maxx    = 239
   333                              defc maxy    = 80
   334                          ENDIF
   335                          
   336                          IF FORosca
   337                              DEFINE gotgfx
   338                              defc maxx    = 320
   339                              defc maxy    = 200
   340                              ; untested 240 lines resolution, see 'libsrc/graphics/osca'
   341                              ;defc maxy    = 240
   342                          ENDIF
   343                          
   344                          IF FORc128hr
   345                              DEFINE gotgfx
   346                              defc maxx    = 640
   347                              defc maxy    = 200
   348                          ENDIF
   349                          
   350                          IF FORc128hr480
   351                              DEFINE gotgfx
   352                              defc maxx    = 640
   353                              defc maxy    = 480
   354                          ENDIF
   355                          
   356                          IF FORts2068
   357                              DEFINE gotgfx
   358                              defc maxx       = 512
   359                              defc maxy       = 192
   360                              defc    WANT_swapgfxbk = 0
   361                          ENDIF
   362                          
   363                          IF FORzxn
   364                              DEFINE gotgfx
   365                              defc maxx       = 512
   366                              defc maxy       = 192
   367                              defc    WANT_swapgfxbk = 0
   368                          ENDIF
   369                          
   370                          IF FORtiki100
   371                              DEFINE gotgfx
   372                              defc maxx       = 1024
   373                              defc maxy       = 256
   374                          ENDIF
   375                          
   376                          IF FORenterprise
   377                              DEFINE gotgfx
   378                              defc maxx       = 336
   379                              defc maxy       = 243
   380                          ENDIF
   381                          
   382                          IF FORenterprisehr
   383                              DEFINE gotgfx
   384                              defc maxx       = 672
   385                              defc maxy       = 243
   386                          ENDIF
   387                          
   388                          IF FORz88
   389                              DEFINE gotgfx
   390                              defc    maxx    = 256
   391                              defc    maxy     = 64
   392                          ENDIF
   393                          
   394                          IF FORz9001
   395                              DEFINE gotgfx
   396                              defc maxx    = 320
   397                              defc maxy    = 192
   398                              defc    WANT_swapgfxbk = 0
   399                              defc blankch = 32
   400                          ENDIF
   401                          
   402                          IF FORkc
   403                              DEFINE gotgfx
   404                              defc maxx    = 320
   405                              defc maxy    = 256
   406                          ENDIF
   407                          
   408                          IF FORaussie
   409                              DEFINE gotgfx
   410                              defc maxx    = 640
   411                              defc maxy    = 576
   412                          ENDIF
   413                          
   414                          IF FORaquarius
   415                              DEFINE gotgfx
   416                              defc maxx    = 80
   417                              defc maxy    = 72
   418                              defc blankch    = 160
   419                          ENDIF
   420                          
   421                          IF FORaqplus
   422                              DEFINE gotgfx
   423                              defc maxx    = 320
   424                              defc maxy    = 299
   425                          ENDIF
   426                          
   427                          IF FORaq48
   428                              DEFINE gotgfx
   429                              defc maxx    = 80
   430                              defc maxy    = 48
   431                              defc blankch    = 160
   432                          ENDIF
   433                          
   434                          IF FORz1013
   435                              DEFINE gotgfx
   436                              defc maxx    = 256
   437                              defc maxy    = 256
   438                              defc    WANT_swapgfxbk = 0
   439                          ENDIF
   440                          
   441                          
   442                          IF FORc128
   443                              DEFINE gotgfx
   444                              defc maxx    = 80
   445                              defc maxy    = 50
   446                              defc blankch    = 32
   447                          ENDIF
   448                          
   449                          IF FORc128udg
   450                              DEFINE gotgfx
   451                              defc maxx    = 80
   452                              defc maxy    = 75
   453                              defc blankch    = 0
   454                          ENDIF
   455                          
   456                          IF FORfp1100
   457                              DEFINE gotgfx
   458                              defc maxx    = 640
   459                              defc maxy    = 200
   460                              defc blankch    = 32
   461                              defc USEplotc   = 1
   462                              defc    WANT_swapgfxbk = 0
   463                          ENDIF
   464                          
   465                          IF FORgal
   466                              DEFINE gotgfx
   467                              ; This size reflects the Gal+ screen mode
   468                                  IF textgraphics
   469                                      defc maxx    = 64
   470                                  defc maxy    = 48
   471                                  ELSE
   472                                      defc maxx    = 256
   473                                  defc maxy    = 208
   474                                  ENDIF
   475                              defc blankch    = 32
   476                              defc    WANT_swapgfxbk = 0
   477                          ENDIF
   478                          
   479                          IF FORnascom
   480                              DEFINE gotgfx
   481                              defc maxx    = 96
   482                              defc maxy    = 48
   483                              defc blankch    = 32
   484                          ENDIF
   485                          
   486                          IF FORtrs80
   487                              DEFINE gotgfx
   488                              defc maxx    = 128
   489                              defc maxy    = 48
   490                              defc blankch    = 128
   491                              defc    WANT_swapgfxbk = 0
   492                          ENDIF
   493                          
   494                          IF FORtrs80m2
   495                              DEFINE gotgfx
   496                              defc maxx    = 80
   497                              defc maxy    = 72
   498                              defc blankch    = 32
   499                              defc GFXTEXT3 = 1
   500                          ENDIF
   501                          
   502                          IF FORtrs80m4
   503                              DEFINE gotgfx
   504                              defc maxx    = 160
   505                              defc maxy    = 72
   506                              defc blankch    = 128
   507                          ENDIF
   508                          
   509                          IF FOReg2000
   510                              DEFINE gotgfx
   511                              defc maxx    = 160
   512                              defc maxy    = 102
   513                          ENDIF
   514                          
   515                          IF FORhrg1
   516                              DEFINE gotgfx
   517                              defc maxx    = 384
   518                              defc maxy    = 192
   519                          ENDIF
   520                          
   521                          IF FORgrafyx3
   522                              DEFINE gotgfx
   523                              defc maxx    = 512
   524                              defc maxy    = 192
   525                          ENDIF
   526                          
   527                          IF FORgrafyx4
   528                              DEFINE gotgfx
   529                              defc maxx    = 640
   530                              defc maxy    = 240
   531                          ENDIF
   532                          
   533                          IF FORp2000
   534                              DEFINE gotgfx
   535                              defc maxx    = 78
   536                              defc maxy    = 72
   537                              defc blankch    = 0
   538                          ENDIF
   539                          
   540                          IF FORpx4
   541                              DEFINE gotgfx
   542                              defc maxx    = 240
   543                              defc maxy    = 64
   544                          ENDIF
   545                          
   546                          IF FORpx8
   547                              DEFINE gotgfx
   548                              defc maxx    = 480
   549                              defc maxy    = 64
   550                          ENDIF
   551                          
   552                          IF FORnc100
   553                              DEFINE gotgfx
   554                              defc maxx    = 480
   555                              defc maxy    = 64
   556                          ENDIF
   557                          
   558                          IF FORnc200
   559                              DEFINE gotgfx
   560                              defc maxx    = 480
   561                              defc maxy    = 128
   562                          ENDIF
   563                          
   564                          IF FORvg5k
   565                              DEFINE gotgfx
   566                              defc maxx    = 80
   567                              defc maxy    = 75
   568                              defc blankch    = 0
   569                              defc    WANT_swapgfxbk = 0
   570                          ENDIF
   571                          
   572                          IF FORsorcerer
   573                              DEFINE gotgfx
   574                              defc maxx    = 128
   575                              defc maxy    = 60
   576                              defc blankch    = 32
   577                          ENDIF
   578                          
   579                          IF FORpacman
   580                              DEFINE gotgfx
   581                              defc maxx    = 84
   582                              defc maxy    = 72
   583                              defc blankch    = 192
   584                          ENDIF
   585                          
   586                          IF FORpv1000
   587                              DEFINE gotgfx
   588                              defc maxx    = 56
   589                              defc maxy    = 48
   590                              defc    WANT_swapgfxbk = 0
   591                          ENDIF
   592                          
   593                          IF FORalphatro
   594                              DEFINE gotgfx
   595                              defc maxx    = 160
   596                              defc maxy    = 72
   597                              defc blankch    = 32
   598                              defc    WANT_swapgfxbk = 0
   599                          ENDIF
   600                          
   601                          IF FORhemc
   602                              DEFINE gotgfx
   603                              defc maxx    = 64        ;Text graphics settings
   604                              defc maxy    = 24
   605                              defc blankch    = 32
   606                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   607                              defc    WANT_swapgfxbk = 0
   608                          ENDIF
   609                          
   610                          IF FORhgmc
   611                              DEFINE    gotgfx
   612                              defc    maxx = 256
   613                              defc    maxy = 256
   614                              defc    WANT_swapgfxbk = 0
   615                              defc    BITS_reversed = 1
   616                          ENDIF
   617                          
   618                          
   619                          IF FORspc1000
   620                              DEFINE gotgfx
   621                              ;defc maxx    = 64        ;Text graphics settings
   622                              ;defc maxy    = 48
   623                              defc maxx    = 256        ;Graphics/VDP
   624                              defc maxy    = 192
   625                              defc blankch    = 32
   626                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   627                              defc    WANT_swapgfxbk = 0
   628                          ENDIF
   629                          
   630                          IF FORsmc777
   631                              DEFINE gotgfx
   632                              defc maxx    = 640
   633                              defc maxy    = 200
   634                              defc    WANT_swapgfxbk = 0
   635                          ENDIF
   636                          
   637                          IF FORmulti8
   638                              DEFINE gotgfx
   639                              defc maxx    = 640
   640                              defc maxy    = 200
   641                              defc    WANT_swapgfxbk = 0
   642                          ENDIF
   643                          
   644                          IF FORrx78
   645                              DEFINE gotgfx
   646                              defc maxx    = 192
   647                              defc maxy    = 184
   648                              defc    WANT_swapgfxbk = 0
   649                          ENDIF
   650                          
   651                          IF FORlynx
   652                              DEFINE gotgfx
   653                              defc maxx    = 64        ;Text graphics settings
   654                              defc maxy    = 64
   655                              defc blankch    = 0
   656                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   657                              defc    WANT_swapgfxbk = 0
   658                          ENDIF
   659                          
   660                          IF FORx1
   661                              DEFINE gotgfx
   662                              defc maxx    = 640
   663                              defc maxy    = 200
   664                              defc    WANT_swapgfxbk = 0
   665                          ENDIF
   666                          
   667                          IF FORlaser500
   668                              DEFINE gotgfx
   669                              defc maxx = 320
   670                              defc maxy = 192
   671                              defc blankch = 32
   672                              defc    WANT_swapgfxbk = 0
   673                          ENDIF
   674                          
   675                          IF FORexcali64
   676                              DEFINE gotgfx
   677                              defc maxx = 160
   678                              defc maxy = 72
   679                              defc blankch = 32
   680                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   681                              defc USEindex = 1
   682                              defc    WANT_swapgfxbk = 0
   683                          ENDIF
   684                          
   685                          IF FORz80tvgame
   686                              DEFINE gotgfx
   687                              defc maxx = 168
   688                              defc maxy = 208
   689                              defc blankch = 32
   690                              defc    WANT_swapgfxbk = 0
   691                          ENDIF
   692                          
   693                          IF FORsv8000
   694                              DEFINE gotgfx
   695                              defc maxx = 256
   696                              defc maxy = 96
   697                              defc blankch = 32
   698                              defc    WANT_swapgfxbk = 0
   699                          ENDIF
   700                          
   701                          IF FORpmd85
   702                              DEFINE gotgfx
   703                              defc maxx = 288
   704                              defc maxy = 256
   705                              defc blankch = 32
   706                              defc    WANT_swapgfxbk = 0
   707                          ENDIF
   708                          
   709                          IF FORm100
   710                              DEFINE gotgfx
   711                              defc maxx = 240
   712                              defc maxy = 64
   713                          ENDIF
   714                          
   715                          IF FORvector06c
   716                              DEFINE gotgfx
   717                              defc maxx = 256
   718                              defc maxy = 256
   719                              defc blankch = 32
   720                              defc    WANT_swapgfxbk = 0
   721                          ENDIF
   722                          
   723                          IF FORspecial
   724                              DEFINE gotgfx
   725                              defc maxx = 384
   726                              defc maxy = 256
   727                              defc blankch = 32
   728                              defc    WANT_swapgfxbk = 0
   729                          ENDIF
   730                          
   731                          IF FORhomelab
   732                              DEFINE gotgfx
   733                              defc maxx = 128
   734                              defc maxy = 64
   735                              defc    WANT_swapgfxbk = 0
   736                          ENDIF
   737                          
   738                          IF FORhomelab2
   739                              DEFINE gotgfx
   740                              defc maxx = 80
   741                              defc maxy = 50
   742                              defc    WANT_swapgfxbk = 0
   743                          ENDIF
   744                          
   745                          IF FORgb
   746                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   747                              defc    WANT_swapgfxbk = 0
   748                          ENDIF
   749                          
   750                          IF FORmikro80
   751                              defc USEplotc = 1
   752                              defc    WANT_swapgfxbk = 0
   753                          ENDIF
   754                          
   755                          IF FORondra
   756                              DEFINE gotgfx
   757                              defc maxx    = 320
   758                              defc maxy    = 256
   759                              defc    WANT_swapgfxbk = 0
   760                          ENDIF
   761                          
   762                          IF FORlviv
   763                              DEFINE gotgfx
   764                              defc maxx    = 256
   765                              defc maxy    = 256
   766                              defc    WANT_swapgfxbk = 0
   767                          ENDIF
   768                          
   769                          IF FORvti
   770                              DEFINE gotgfx
   771                              defc maxx    = 128
   772                              defc maxy    = 48
   773                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   774                              defc blankch    = 160
   775                              defc    WANT_swapgfxbk = 0
   776                          ENDIF
   777                          
   778                          IF FORvio
   779                              DEFINE gotgfx
   780                              defc maxx    = 160
   781                              defc maxy    = 72
   782                              defc blankch    = 32
   783                              defc    WANT_swapgfxbk = 0
   784                          ENDIF
   785                          
   786                          IF FORvdm
   787                              DEFINE gotgfx
   788                              defc maxx    = 64
   789                              defc maxy    = 16
   790                              defc USEplotc   = 1        ; We call generic_console_plotc, not _printc for text mode
   791                              defc    WANT_swapgfxbk = 0
   792                          ENDIF
   793                          
   794                          IF FORkrokha
   795                              DEFINE gotgfx
   796                              defc maxx    = 96
   797                              defc maxy    = 64
   798                              defc    WANT_swapgfxbk = 0
   799                          ENDIF
   800                          
   801                          IF FORgl6000
   802                              DEFINE gotgfx
   803                              defc maxx    = 240
   804                              defc maxy    = 100
   805                              defc    WANT_swapgfxbk = 0
   806                          ENDIF
   807                          
   808                          IF FORsol20
   809                              DEFINE gotgfx
   810                              defc maxx    = 64
   811                              defc maxy    = 16
   812                              defc USEplotc = 1
   813                          ENDIF
   814                          
   815                          ; GSX virtual window is (32768 x 32768)
   816                          ; HiRez display should stay between 512..800 px.
   817                          ; We keep an average value
   818                          IF FORcpm
   819                            IF FORgsx
   820                              DEFINE gotgfx
   821                              defc maxx    = 1920        ; foo value hopefully larger than the max X resolution
   822                              defc maxy    = 768        ; we keep unbalanced proportions, assuming non-square pixels
   823                            ENDIF
   824                          ENDIF
   825                          
   826                          ; =============================================
   827                          
   828                          IF FORtek
   829                             DEFINE gotgfx
   830                             defc maxx = 1024
   831                             defc maxy = 768
   832                             defc    WANT_swapgfxbk = 0
   833                          ENDIF
   834                          
   835                          IF FORregis
   836                             DEFINE gotgfx
   837                             defc maxx = 768
   838                             defc maxy = 480
   839                          ENDIF
   840                          
   841                          IF FORagon
   842                             DEFINE gotgfx
   843                             defc maxx = 1024
   844                             defc maxy = 768
   845                             defc    WANT_swapgfxbk = 0
   846                          ENDIF
   847                          
   848                          IF FORtim011
   849                             DEFINE gotgfx
   850                             defc maxx = 512
   851                             defc maxy = 256
   852                             defc    WANT_swapgfxbk = 0
   853                          ENDIF
   854                          
   855                          ; Catch all to sort things out
   856                          
   857                          IF !gotgfx
   858                              defc    maxx = 256
   859                              defc    maxy = 192
   860                          ENDIF
   861                          
   862                          IF WANT_swapgfxbk
   863                              defc    NEED_swapgfxbk = 0
   864                          ELSE
   865                              defc    NEED_swapgfxbk = 1
   866                          ENDIF
   867                          
   868                          
   869                          
   870                          ;       Structure for open window       struct *window
   871                          
   872                          DEFVARS 0
   873                          {
   874                                  windnum ds.b    1
   875                                  wind_x  ds.b    1
   876                                  wind_y  ds.b    1
   877                                  wind_w  ds.b    1       ;width/map width
   878                                  wind_d  ds.b    1       ;
   879                                  type    ds.b    1       ;
   880                                  graph   ds.b    1       ;0=text 1=graphics
   881                          }
   882                          
draw_profile_nostencil.asm:
    13                          
    14                            IF    !__CPU_INTEL__&!__CPU_GBZ80__
    15                                  SECTION code_graphics
    16                                  PUBLIC  draw_profile
    17                                  PUBLIC  _draw_profile
    18                          
    19                                       ;EXTERN    stencil_init
    20                                       ;EXTERN    stencil_render
    21                                       ;EXTERN    stencil_add_point
    22                                       ;EXTERN    stencil_add_lineto
    23                                       ;EXTERN    stencil_add_side
    24                                  EXTERN  plot
    25                                  EXTERN  unplot
    26                                  EXTERN  draw
    27                                  EXTERN  undraw
    28                                  EXTERN  drawto
    29                                  EXTERN  undrawto
    30                          
    31                                  EXTERN  l_mult
    32                                  EXTERN  l_div
    33                          
    34                                  EXTERN  getmaxx
    35                          
    36                          
    37                          getbyte:
    38                                  ld      hl, (_pic)
    39                                  ld      a, (hl)
    40                                  inc     hl
    41                                  ld      (_pic), hl
    42                                  ret
    43                          
    44                          getx:
    45                                  call    getmaxx
    46                                  ld      a, h
    47                                  push    af
    48                                  ld      hl, (_vx)
    49                                  call    getparm
    50                                  pop     af
    51                                  and     $fe
    52                                  ret     z
    53                                  add     hl, hl                  ; double size for X in wide mode !
    54                                  ret
    55                          
    56                          gety:
    57                                  ld      hl, (_vy)
    58                                  call    getparm
    59                                  ret
    60                          
    61                          getparm:                                ;cx=vx+percent*pic[x++]/100;
    62                                  push    hl
    63                                  ld      de, (_percent)
    64                                  call    getbyte
    65                                  ld      h, 0
    66                                  ld      l, a
    67                                  call    l_mult
    68                                  ld      de, 100
    69                                  ex      de, hl
    70                                  call    l_div
    71                                  pop     de
    72                                  add     hl, de
    73                          ;	ld	a,$F0	; negative value ?
    74                          ;	and	h
    75                          ;	ret z
    76                          ;	ld	hl,0
    77                                  ret
    78                          
    79                          
    80                          ; *************************
    81                          ;    MAIN FUNCTION ENTRY
    82                          ; *************************
    83                          
    84                          draw_profile:
    85                          _draw_profile:
    86                                  push    ix
    87                                  ld      ix, 2
    88                                  add     ix, sp
    89                                  ld      l, (ix+2)
    90                                  ld      h, (ix+3)
    91                                  ld      (_pic), hl
    92                                  ld      h, 0
    93                                  ld      l, (ix+4)
    94                                  ld      (_percent), hl
    95                                  ld      l, (ix+6)
    96                                  ld      (_vy), hl
    97                                  ld      l, (ix+8)
    98                                  ld      (_vx), hl
    99                          
   100                          	;ld     hl,-maxy*4	; create space for stencil on stack
   101                          	;add    hl,sp    ; The stack usage depends on the display height.
   102                          	;ld     sp,hl
   103                          	;ld    (_stencil),hl
   104                          
   105                          picture_loop:
   106                                  ld      a, (repcnt)
   107                                  and     a
   108                                  jr      z, norepeat
   109                                  dec     a
   110                                  ld      (repcnt), a
   111                                  ld      a, (repcmd)
   112                                  jr      noend
   113                          norepeat:
   114                                  call    getbyte
   115                                  and     a                       ; CMD_END ?
   116                                  jr      nz, noend
   117                          	;******
   118                          	; EXIT
   119                          	;******
   120                          	;ld     hl,maxy*2	; release the stack space for _stencil
   121                          	;add    hl,sp
   122                          	;ld     sp,hl
   123                                  pop     ix
   124                                  ret
   125                          
   126                          noend:
   127                                  ld      e, a
   128                                  and     $0F                     ; 'dithering level'
   129                                  ld      h, 0
   130                                  ld      l, a
   131                                  ld      (_dith), hl
   132                                  ld      a, e
   133                                  and     $F0                     ; command
   134                          
   135                          	;ld	hl,(_stencil)
   136                          
   137                          ;#define CMD_AREA_INIT    0x80	/* no parms */
   138                          ;#define CMD_AREA_INITB    0x81	/* activate border mode */
   139                          ;#define REPEAT_COMMAND    0x82	/* times, command */
   140                          
   141                                  cp      $80                     ; CMD_AREA_INIT (no parameters)
   142                                  jr      nz, noinit
   143                                  push    hl                      ; _stencil
   144                                  ld      a, (_dith)
   145                                  cp      2
   146                                  jr      z, do_repeat
   147                                  ld      hl, 0
   148                                  ld      (_areaptr), hl
   149                                  and     a                       ; no parameters ?
   150                                  jr      z, just_init            ; then, don't keep ptr for border
   151                                  dec     a
   152                                  jr      z, init_loop            ;$81 ?
   153                          	; else (82..) REPEAT_COMMAND
   154                          do_repeat:
   155                                  call    getbyte
   156                                  ld      (repcnt), a
   157                                  call    getbyte
   158                                  ld      (repcmd), a
   159                                  jp      go_end1
   160                          init_loop:
   161                                  ld      hl, (_pic)              ; >0, so save current pic ptr
   162                                  ld      (_areaptr), hl
   163                          just_init:
   164                                  pop     hl
   165                                  push    hl                      ; _stencil
   166                          	;;;;call stencil_init
   167                                  jp      go_end1
   168                          noinit:
   169                          
   170                                  cp      $F0                     ; CMD_AREA_CLOSE (no parameters ?)
   171                                  jr      nz, noclose
   172                          ;----
   173                                  call    is_areamode
   174                                  jr      z, noclsamode
   175                                  push    hl
   176                                  ld      hl, (_areaptr)
   177                                  ld      (_pic), hl              ; update picture pointer to pass the area
   178                                  ld      hl, 0                   ; twice and draw the border
   179                                  ld      (_areaptr), hl
   180                                  pop     hl
   181                          noclsamode:
   182                          ;----
   183                                  push    hl                      ; _stencil
   184                                  ld      hl, (_dith)
   185                                  ld      a, l
   186                                  sub     12
   187                                  jr      c, doclose
   188                          	; if color > 11 we roughly leave a black border by shrinking
   189                          	; the stencil boudaries, then we subtract 7 and fill with the
   190                          	; resulting dithering level (12..15 -> 4..7)
   191                                  ld      l, 11                   ; black border
   192                                  push    hl
   193                          	;;;;call stencil_render
   194                                  pop     de
   195                                  pop     hl
   196                          	;ld	hl,(_stencil)	; 'render' can destroy the current parameter
   197                                  push    hl
   198                          	;ld	e,1    ; left side border
   199                          	;call resize
   200                          	;ld	e,-1	; right side border
   201                          	;call resize
   202                          	;pop hl
   203                          	;push hl
   204                          	;call vshrink	; upper side border
   205                          	;;;ld	hl,_stencil+maxy
   206                          	;ld	hl,_stencil
   207                          	;ld	de,maxy
   208                          	;add	hl,de
   209                          	;call vshrink	; lower side border
   210                                  ld      hl, (_dith)
   211                                  ld      a, l
   212                                  sub     7                       ; adjust dithering to mid values
   213                                  ld      l, a
   214                          doclose:
   215                                  jp      dorender
   216                          noclose:
   217                                  push    af
   218                          
   219                          ;----
   220                                  call    is_areamode
   221                                  jr      z, noamode              ; if in 'area mode', we are doing twice;
   222                                  pop     af                      ; in the first pass, plot/line CMDs
   223                                  or      $80                     ; are changed to the equivalent area ones
   224                                  push    af
   225                          noamode:
   226                          ;----
   227                          
   228                                  pop     af
   229                                  push    af
   230                          
   231                                  cp      $30                     ; CMD_HLINETO (1 parameter)
   232                                  jr      z, xparm
   233                                  cp      $B0                     ; CMD_AREA_HLINETO (1 parameter)
   234                                  jr      nz, noxparm
   235                          xparm:
   236                                  call    getx
   237                                  ld      (_cx), hl
   238                                  jr      twoparms
   239                          noxparm:
   240                          
   241                                  cp      $40                     ; CMD_VLINETO (1 parameter)
   242                                  jr      z, yparm
   243                                  cp      $C0                     ; CMD_AREA_VLINETO (1 parameter)
   244                                  jr      nz, noyparm
   245                          yparm:
   246                                  call    gety
   247                                  ld      (_cy), hl
   248                                  jr      twoparms
   249                          noyparm:
   250                          
   251                                  cp      $50                     ; CMD_LINE (4 parameters ?)
   252                                  jr      z, fourparms
   253                                  cp      $D0                     ; CMD_AREA_LINE (4 parameters ?)
   254                          fourparms:
   255                                  push    af                      ; keep zero flag
   256                                  call    getx
   257                                  ld      (_cx), hl
   258                                  call    gety
   259                                  ld      (_cy), hl
   260                                  pop     af                      ; recover zero flag
   261                                  jr      nz, twoparms
   262                                  call    getx
   263                                  ld      (_cx1), hl
   264                                  call    gety
   265                                  ld      (_cy1), hl
   266                          twoparms:
   267                          
   268                                  pop     af
   269                          
   270                                  ld      hl, (_cx)
   271                                  push    hl
   272                                  ld      hl, (_cy)
   273                                  push    hl
   274                          
   275                                  cp      $90                     ; CMD_AREA_PLOT (x,y)
   276                                  jr      nz, noaplot
   277                          	;ld	hl,(_stencil)
   278                                  push    hl
   279                          	;;;;call stencil_add_point
   280                                  jr      go_end3
   281                          noaplot:
   282                          
   283                                  cp      $A0                     ; CMD_AREA_LINETO (x,y)
   284                                  jr      c, noaline
   285                                  cp      $D0
   286                                  jr      z, aline
   287                                  jr      nc, noaline             ; >= CMD_AREA_VLINETO
   288                          	; AREA_LINETO stuff
   289                          	;ld	hl,(_stencil)
   290                                  push    hl
   291                          	;;;;call stencil_add_lineto
   292                                  jr      go_end3
   293                          
   294                          aline:
   295                          	;cp $D0 ; CMD_AREA_LINE (x1,x2,y1,y2)
   296                          	;jr	nz,noaline
   297                                  ld      hl, (_cx1)
   298                                  ld      (_cx), hl               ; update also the first parameter couple...
   299                                  push    hl
   300                                  ld      hl, (_cy1)
   301                                  ld      (_cy), hl               ; ..so VLINE and HLINE behave correctly
   302                                  push    hl
   303                          	;ld	hl,(_stencil)
   304                                  push    hl
   305                          	;;;;call stencil_add_side
   306                                  pop     hl
   307                          go_end4:
   308                                  pop     hl
   309                          go_end3:
   310                                  pop     hl
   311                          go_end2:
   312                                  pop     hl
   313                          go_end1:
   314                                  pop     hl
   315                                  jp      picture_loop
   316                          noaline:
   317                          
   318                                  cp      $10                     ; CMD_PLOT (x,y,dither),
   319                                  jr      nz, noplot
   320                          	;ld	hl,(_stencil)
   321                                  ld      a, (_dith)
   322                                  and     a                       ; when possible drawto/undrawto are faster
   323                                  jr      nz, nopwhite
   324                                  call    unplot
   325                                  jr      go_end2
   326                          nopwhite:
   327                          	;sub 11
   328                          	;jr	nz,nopblack
   329                                  call    plot
   330                                  jr      go_end2
   331                          nopblack:
   332                                  push    hl
   333                          	;;;;call stencil_init
   334                          	;;;;call stencil_add_point
   335                          plend:
   336                                  pop     de                      ; stencil ptr
   337                          plend2:
   338                                  pop     hl
   339                                  pop     hl
   340                                  push    de                      ; stencil ptr
   341                                  ld      hl, (_dith)
   342                                  ld      a, l
   343                                  sub     12                      ; If color > 11, then fatten a bit
   344                                  jr      c, nothick              ; the surface to be drawn
   345                          
   346                          	;push hl
   347                          	;ld hl,(_stencil)	; adjust the right side
   348                          	;ld	de,maxy
   349                          	;add	hl,de
   350                          	;ld e,1       ; 1 bit larger
   351                          	;call resize
   352                          	;pop hl
   353                                  ld      a, l
   354                                  sub     4                       ; adjust color (8..11)
   355                                  ld      l, a
   356                          nothick:
   357                          dorender:
   358                                  push    hl
   359                          	;;;;call stencil_render
   360                                  pop     hl
   361                                  pop     hl
   362                          	;ld	hl,(_stencil)	; 'render' can destroy the current parameter
   363                                  push    hl
   364                          	;;;;call stencil_init
   365                                  jr      go_end1
   366                          
   367                          noplot:
   368                          
   369                                  cp      $20                     ; CMD_LINETO (x,y,dither),
   370                                  jr      c, go_end2
   371                                  cp      $50                     ; CMD_LINE
   372                                  jr      z, line
   373                                  jr      nc, go_end2
   374                          	; LINETO stuff
   375                          	;ld hl,(_stencil)
   376                                  ld      a, (_dith)
   377                                  and     a                       ; when possible drawto/undrawto are faster
   378                                  jr      nz, nodtwhite
   379                                  call    undrawto
   380                                  jr      go_end2
   381                          nodtwhite:
   382                                  sub     11
   383                                  jr      nz, nodtblack
   384                                  call    drawto
   385                                  jr      go_end2
   386                          nodtblack:
   387                                  push    hl
   388                          	;;;;call stencil_init
   389                          	;;;;call stencil_add_lineto
   390                                  jr      plend
   391                          
   392                          line:
   393                          	;cp $50 ; CMD_LINE (x,y,x2,y2,dither),
   394                          	;jr	nz,go_end2
   395                                  ld      hl, (_cx1)
   396                                  ld      (_cx), hl               ; update also the first parameter couple...
   397                                  push    hl
   398                                  ld      hl, (_cy1)
   399                                  ld      (_cy), hl               ; ..so VLINE and HLINE behave correctly
   400                                  push    hl
   401                          	;ld	hl,(_stencil)
   402                                  ld      a, (_dith)
   403                                  and     a                       ; when possible draw/undraw are faster
   404                                  jr      nz, nolwhite
   405                                  call    undraw
   406                                  jp      go_end4
   407                          nolwhite:
   408                                  sub     11
   409                                  jr      nz, nolblack
   410                                  call    draw
   411                                  jp      go_end4
   412                          nolblack:
   413                                  push    hl
   414                          	;;;;call stencil_init
   415                          	;;;;call stencil_add_side
   416                                  pop     de
   417                                  pop     hl
   418                                  pop     hl
   419                                  jp      plend2
   420                          
   421                          ;
   422                          ; Adjust right or left margin
   423                          ; of a stencil object by 'e' dots
   424                          ;
   425                          
   426                          ;resize:
   427                          ;	ld b,maxy-1
   428                          ;rslp:
   429                          ;	ld a,(hl)
   430                          ;	and a
   431                          ;	jr z,slimit
   432                          ;	cp maxx-1
   433                          ;	jr z,slimit
   434                          ;	add e
   435                          ;	ld (hl),a
   436                          ;slimit:
   437                          ;	inc hl
   438                          ;	djnz rslp
   439                          ;	ret
   440                          
   441                          ; NZ if we have prepared a ptr for two-pass mode
   442                          is_areamode:
   443                                  push    hl                      ; _stencil
   444                                  ld      hl, _areaptr
   445                                  ld      a, (hl)
   446                                  inc     hl
   447                                  cp      (hl)
   448                                  pop     hl
   449                                  ret
   450                          
   451                                  SECTION bss_graphics
   452                          _areaptr:
   453                                  defw    0
   454                          
   455                          _percent:
   456                                  defw    0
   457                          _cmd:   defb    0
   458                          _dith:  defw    0
   459                          _vx:    defw    0
   460                          _vy:    defw    0
   461                          
   462                          _cx:    defw    0
   463                          _cy:    defw    0
   464                          _cx1:   defw    0
   465                          _cy1:   defw    0
   466                          
   467                          _pic:   defw    0
   468                          
   469                          repcmd: defb    0
   470                          repcnt: defb    0
   471                          
   472                            ENDIF
   473                          
